---
title: "Rule Based System - Example"
author: "TJC"
date: "2024-08-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Borrowed from: https://bookdown.org/kochiuyu/Technical-Analysis-with-R/evaluating-trading-rules.html

## Performance Evaluation
```{r Performance Analytics}

# Load libraries
library(PerformanceAnalytics)
        # install.packages("PerformanceAnalytics")
library(quantmod)
          # install.packages("quantmod")




```


## Evaluating Trading Rules
To simplify, we first evaluate several trading rules based on day trading:

1. buy signal based on simple filter rule
2. buy and sell signals based on simple filter rule
3. buy signal based on RSI
4. buy signal based on EMA and sell signal based on RSI
5. buy signal based on RSI but trading size depends on price history
6. Finally, we consider the rule that does non-day trading. In this case, we need to keep track of both cash and stock holdings.

Simple filter Buy
Here we create trading signal based on simple filter rule. Recall that simple filter rule suggests buying when the price increases a lot compared to the yesterday price:

Buy: (Pt/Pt-1)>(1+x)

where Pt is the closing price at time t & x>0 is an arbitrary threshold

We illustrate using Microsoft with ticker MSFT.
We first download the data using getSymbols(“MSFT”).

## Get Data
```{r fetch data}

# Install and load required packages
if (!requireNamespace("quantmod", quietly = TRUE)) {
  install.packages("quantmod")
}
library(quantmod)

# Set dates
date_end_EQ <- Sys.Date()  # End date is today
date_start_EQ <- as.Date(date_end) - 2*365  # Start date is one year ago

# Fetch Data
getSymbols(c("GOOG","AAPL","MSFT"), src = "yahoo", from = date_start_EQ, to = date_end_EQ, auto.assign = TRUE)

```

```{r calculate chg%}

# We first will use closing price to perform calculation. We calculate the percentage price change by dividing the current close price by its own lag and then minus 1

# Now we generate buying signal based on filter rule:

price <- Cl(MSFT) # close price
r <- price/Lag(price) - 1 # % price change
delta <-0.005 #threshold
signal <-c(0) # first date has no signal

#Loop over all trading days (except the first)
for (i in 2: length(price)){
  if (r[i] > delta){
    signal[i]<- 1
  } else
    signal[i]<- 0
}

# Note that signal is just a vector without time stamp. We use the function reclass to convert it into an xts object.

# Each data is not attached with time
head(signal, n=3)

# Assign time to action variable using reclass;
signal<-reclass(signal,price)

# Each point is now attached with time
tail(signal, n=3)

# We are now ready to chart the trading indicators:

# Charting with Trading rule
chartSeries(MSFT,
            type = 'line',
            subset="2024",
            theme=chartTheme('white'))

addTA(signal,type='S',col='red')

# We consider trading based on yesterday indicator:

trade <- Lag(signal,1) # trade based on yesterday signal

# To keep it simple, we evaluate using day trading:
# buy at open
# sell at close
# trading size: all in
# Then daily profit rate is dailyReturn=((close-open)/open) 

ret<-dailyReturn(MSFT)*trade
names(ret)<-"filter"

# Based on daily return, we can see the summary of performance using charts.PerformanceSummary() to evaluate the performance.
#Performance Summary
charts.PerformanceSummary(ret, main="Naive Buy Rule")


```




